#!/usr/bin/env bash

if [[ -z "$1" || "$1" == "-h" || "$1" == "--help" ]]; then
    echo "-----"
    echo " Descr: Wrapper for cram2bam and bam2fastq"
    echo " Usage: $(basename $0) <CRAM file>"
    echo " Examp: nohup $(basename $0) <CRAM file> > cram2fastq.log &"
    echo "-----"
    exit 1
fi

cram=$1

echo "[INFO] Starting with cram2fastq [${cram}]"

if [[ ${cram} =~ ^gs ]]; then
    gsutil -m cp ${cram} ./
else
    echo "[ERROR] No GCP file inputted"
    exit 1
fi

cram_downloaded=./${cram##*/}
echo "[RUN] cram2bam: [${cram_downloaded}]"
./cram2bam "${cram_downloaded}"

bam=$(echo "${cram_downloaded}" | sed 's/cram$/bam/')
echo "[RUN] bam2fastq: [${bam}]"
./bam2fastq "${bam}"

gsutil -m cp ./output/*.fastq.gz gs://hmf-cram2fastq/fastq/sandra/
rm -r ./output

echo "[INFO] Finished with cram2fastq"


