#!/usr/bin/env bash

## see versions of installed apt-get packages
#apt-cache policy openjdk-11-jre
#apt-cache policy pigz
#apt-cache policy libncurses5-dev
#apt-cache policy zlib1g-dev
#apt-cache policy libbz2-dev
#apt-cache policy liblzma-dev

if [[ -z "$1" || "$1" == "-h" || "$1" == "--help" ]]; then
  echo "-----"
  echo " Descr: Wrapper for cram2bam and bam2fastq"
  echo " Usage: $(basename $0) <CRAM file>"
  echo " Examp: nohup $(basename $0) <CRAM file> > cram2fastq.log &"
  echo "-----"
  exit 1
fi

cram=$1
local_cram="${BASEPATH}/local_cram"
local_bam=$(echo "${local_cram}" | sed 's/cram$/bam/')

echo "[INFO] Starting with cram2fastq [${cram}]"

gsutil -m cp "${cram}" "${local_cram}"

cram2bam "${local_cram}"

bam2fastq "${local_bam}"

# At the end you can copy your fastq back into GCS in this location
gsutil -m rsync "${BASEPATH}/local_FASTQ" gs://hmf-cram2fastq/fastq/david/

echo "[INFO] Finished with cram2fastq"
