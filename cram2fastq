#!/usr/bin/env bash

cram_file=$1
fastq_dir="./fastq"
bam_file=${cram_file/.cram/.bam}
bucket="hmf-cram2fastq"

echo "[INFO] Starting cram2fastq"

if [[ "${cram_file}" =~ ^gs ]]; then
    echo "[INFO] Input CRAM is a GCP url so need to download first"
    cram_url="${cram_file}"
    cram_file=$(basename "${cram_url}")
    bam_file=${cram_file/.cram/.bam}

    echo "[INFO] Downloading [${cram_url}]"
    gsutil -m cp "${cram_url}" ./
fi

echo "[INFO] Starting cram2bam"
./cram2bam "${cram_file}" "${bam_file}" || exit 1

echo "[INFO] Starting bam2fastq"
./bam2fastq "${bam_file}" "${fastq_dir}"  || exit 1

echo "[INFO] Copying output fastq to GCP (${bucket})"
gsutil -m cp "${fastq_dir}/*.fastq.gz" "gs://${bucket}/fastq/stef/"

echo "[INFO] Finished with cram2fastq" 
